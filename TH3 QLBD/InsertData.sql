INSERT INTO DOI(MADOI, TENDOI) VALUES
('VN', 'Viet Nam'),
('LA', 'Lao'),
('TL', 'Thai Lan'),
('CPC', 'Campuchia')

INSERT INTO TRANDAU(MATD, MASAN, NGAY, GIO) VALUES
('01', 'MOD', CONVERT(DATE, '14/08/2017', 103), CAST('15:00' AS TIME)),
('02', 'NAS', CONVERT(DATE, '16/08/2017', 103), CAST('17:00' AS TIME)),
('03', 'MOD', CONVERT(DATE, '16/08/2017', 103), CAST('15:00' AS TIME)),
('04', 'IMO', CONVERT(DATE, '18/08/2017', 103), CAST('19:00' AS TIME))

ALTER TABLE TRANDAU ALTER COLUMN GIO TIME(0);

INSERT INTO CT_TRANDAU(MATD, MADOI, SOBANTHANG) VALUES
('01', 'VN' , 3),
('01', 'TL' , 1),
('02', 'VN' , 5),
('02', 'LA' , 0),
('03', 'TL' , 3),
('03', 'CPC' ,3),
('04', 'TL' , 2),
('04', 'LA' , 0)


--CAU1
SELECT D.MADOI, D.TENDOI, COUNT(MATD) AS SoTD
FROM CT_TRANDAU C
JOIN DOI D ON D.MADOI = C.MADOI
GROUP BY D.MADOI, D.TENDOI

--CAU2,3
SELECT  T1.MaTD, 
       CONCAT(T1.MaDoi, '-', T2.MaDoi) AS DoiTranDau,
       CONCAT(T1.SoBanThang, '-', T2.SoBanThang) AS TySo
FROM CT_TranDau T1
JOIN CT_TranDau T2 ON T1.MaTD = T2.MaTD AND T1.MaDoi <> T2.MaDoi
WHERE T1.MADOI < T2.MADOI



--CAU4

SELECT CT.MATD, CT.MADOI, 
	CASE 
	WHEN SOBANTHANG = TMP.MAX_CT AND SOBANTHANG <> TMP.MIN_CT THEN 3
	WHEN SOBANTHANG = TMP.MIN_CT AND SOBANTHANG <> TMP.MAX_CT THEN 0
	ELSE 1 END
	AS DIEM
FROM CT_TRANDAU CT
JOIN
	(SELECT MATD, MAX(SOBANTHANG) AS MAX_CT, MIN(SOBANTHANG) AS MIN_CT
	FROM CT_TRANDAU
	GROUP BY MATD) TMP ON CT.MATD = TMP.MATD

--CAU5
WITH DiemTranDau AS (
SELECT CT.MATD, CT.MADOI, 
	CASE 
	WHEN SOBANTHANG = TMP.MAX_CT AND SOBANTHANG <> TMP.MIN_CT THEN 3
	WHEN SOBANTHANG = TMP.MIN_CT AND SOBANTHANG <> TMP.MAX_CT THEN 0
	ELSE 1 END
	AS DIEM
FROM CT_TRANDAU CT
JOIN
	(SELECT MATD, MAX(SOBANTHANG) AS MAX_CT, MIN(SOBANTHANG) AS MIN_CT
	FROM CT_TRANDAU
	GROUP BY MATD) TMP ON CT.MATD = TMP.MATD
)
SELECT D.MaDoi, D.TenDoi, SUM(Diem) AS TongDiem
FROM Doi D
JOIN DiemTranDau DT ON D.MaDoi = DT.MaDoi
GROUP BY D.MaDoi, D.TenDoi;

--CAU6
WITH MaxMin AS (
    SELECT MaTD, 
           MAX(SoBanThang) AS MaxBanThang, 
           MIN(SoBanThang) AS MinBanThang 
    FROM CT_TranDau 
    GROUP BY MaTD
)
SELECT D.MaDoi, D.TenDoi, 
       SUM(
           CASE 
               WHEN CT.SoBanThang = M.MaxBanThang AND CT.SoBanThang <> M.MinBanThang THEN 3  -- Thắng
               WHEN CT.SoBanThang = M.MinBanThang AND CT.SoBanThang <> M.MaxBanThang THEN 0  -- Thua
               ELSE 1  -- Hòa
           END
       ) AS TongDiem,
       SUM(CT.SoBanThang) - SUM(Opp.SoBanThang) AS HieuSoBanThang
FROM Doi D
JOIN CT_TranDau CT ON D.MaDoi = CT.MaDoi
JOIN MaxMin M ON CT.MaTD = M.MaTD
JOIN CT_TranDau Opp ON CT.MaTD = Opp.MaTD AND CT.MaDoi <> Opp.MaDoi
GROUP BY D.MaDoi, D.TenDoi
ORDER BY TongDiem DESC, HieuSoBanThang DESC;


--CAU7
SELECT D1.MaDoi AS Doi1, D2.MaDoi AS Doi2
FROM Doi D1, Doi D2
WHERE D1.MaDoi < D2.MaDoi
AND NOT EXISTS (
    SELECT 1 FROM CT_TranDau CT1
    JOIN CT_TranDau CT2 ON CT1.MaTD = CT2.MaTD
    WHERE CT1.MaDoi = D1.MaDoi AND CT2.MaDoi = D2.MaDoi
);
